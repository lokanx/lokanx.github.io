<!doctype html>
<!--
  Minimal Mistakes Jekyll Theme 4.24.0 by Michael Rose
  Copyright 2013-2020 Michael Rose - mademistakes.com | @mmistakes
  Free for personal and commercial use under the MIT license
  https://github.com/mmistakes/minimal-mistakes/blob/master/LICENSE
-->
<html lang="en" class="no-js">
  <head>
    <meta charset="utf-8">

<!-- begin _includes/seo.html --><title>How to build docker containers using gitea runners - A developers thoughts…</title>
<meta name="description" content="Gitea has pretty recently introduced actions, which is basically CI/CD pipelines.  They work very match as Gitlab Actions.  In fact a Gitea CI/CD pipeline is almost fully compatible with a Gitlab pipeline except a few minor details and limitations. You can even use Gitlab actions in your Gitea CI/CD pipeline build steps.">


  <meta name="author" content="Björn Sjögren">
  
  <meta property="article:author" content="Björn Sjögren">
  


<meta property="og:type" content="article">
<meta property="og:locale" content="en_US">
<meta property="og:site_name" content="A developers thoughts...">
<meta property="og:title" content="How to build docker containers using gitea runners">
<meta property="og:url" content="https://www.lokan.net/ci/cd/docker/2023/10/27/gitea-runner-build-docker-containers.html">


  <meta property="og:description" content="Gitea has pretty recently introduced actions, which is basically CI/CD pipelines.  They work very match as Gitlab Actions.  In fact a Gitea CI/CD pipeline is almost fully compatible with a Gitlab pipeline except a few minor details and limitations. You can even use Gitlab actions in your Gitea CI/CD pipeline build steps.">







  <meta property="article:published_time" content="2023-10-27T12:30:00+00:00">



  <meta property="article:modified_time" content="2023-10-27T12:30:00+00:00">




<link rel="canonical" href="https://www.lokan.net/ci/cd/docker/2023/10/27/gitea-runner-build-docker-containers.html">




<script type="application/ld+json">
  {
    "@context": "https://schema.org",
    
      "@type": "Person",
      "name": null,
      "url": "https://www.lokan.net/"
    
  }
</script>







<!-- end _includes/seo.html -->



  <link href="/feed.xml" type="application/atom+xml" rel="alternate" title="A developers thoughts... Feed">


<!-- https://t.co/dKP3o1e -->
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<script>
  document.documentElement.className = document.documentElement.className.replace(/\bno-js\b/g, '') + ' js ';
</script>

<!-- For all browsers -->
<link rel="stylesheet" href="/assets/css/main.css">
<link rel="preload" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5/css/all.min.css" as="style" onload="this.onload=null;this.rel='stylesheet'">
<noscript><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5/css/all.min.css"></noscript>



    <!-- start custom head snippets -->

<!-- insert favicons. use https://realfavicongenerator.net/ -->

<!-- end custom head snippets -->

  </head>

  <body class="layout--single wide">
    <nav class="skip-links">
  <ul>
    <li><a href="#site-nav" class="screen-reader-shortcut">Skip to primary navigation</a></li>
    <li><a href="#main" class="screen-reader-shortcut">Skip to content</a></li>
    <li><a href="#footer" class="screen-reader-shortcut">Skip to footer</a></li>
  </ul>
</nav>

    <!--[if lt IE 9]>
<div class="notice--danger align-center" style="margin: 0;">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience.</div>
<![endif]-->

    
<style>
.greedy-nav .hidden-links div {
  margin: 0;
  padding: 10px 20px;
  font-size: 1em;
}
</style>
<div class="masthead">
   <div class="masthead__inner-wrap">
      <div class="masthead__menu">
         <nav id="site-nav" class="greedy-nav">
            
            <a class="site-title" href="/">
               En utvecklares tankar... 
            </a>
            <ul class="visible-links"><li class="masthead__menu-item">
                  <a
                     href="/"
                     
                     >Hem</a
                  >
               </li><li class="masthead__menu-item">
                  <a
                     href="/blog/"
                     
                     >Blog</a
                  >
               </li><li class="masthead__menu-item">
                  <a
                     href="/apps-archive/"
                     
                     >Appl</a
                  >
               </li><li class="masthead__menu-item">
                  <a
                     href="/about/"
                     
                     >Om</a
                  >
               </li><li class="masthead__menu-item">
                  <a
                     href="/contact/"
                     
                     >Kontakt</a
                  >
               </li><li class="masthead__menu-item">
                  <a
                     href="/sitemap/"
                     
                     >Områdeskarta</a
                  >
               </li>
   <li class="masthead__menu-item">
   
      
         <a href=" /"  title="en" style="margin-left: 2px; margin-right: 2px" onClick="localStorage.setItem('site_active_lang', 'en');window.location.href='/';return false;">
            <img
               src="/assets/images/lang/en.svg"
               alt="en"
               style="width: 32px; max-width: 32px;"
            />
         </a>
      

   
   </li>

   <li class="masthead__menu-item">
   
      <div>
         <img
            src="/assets/images/lang/sv.svg"
            alt="sv"
            title="sv"
            style="width: 32px;max-width: 32px; margin-left: 2px; margin-right: 2px"
         />
      </div>
   
   </li>

</ul>
            
            <button class="search__toggle" type="button">
               <span class="visually-hidden"
                  >Toggle search</span
               >
               <i class="fas fa-search"></i>
            </button>
            
            <button class="greedy-nav__toggle hidden" type="button">
               <span class="visually-hidden"
                  >Toggle menu</span
               >
               <div class="navicon"></div>
            </button>
            <ul class="hidden-links hidden"></ul>
         </nav>
      </div>
   </div>
</div>

    <div class="initial-content">
      



<div id="main" role="main">
  
  <div class="sidebar sticky">
  


<div itemscope itemtype="https://schema.org/Person" class="h-card">

  

  <div class="author__content">
    <h3 class="author__name p-name" itemprop="name">
      <a class="u-url" rel="me" href="https://www.lokan.net/" itemprop="url">Björn Sjögren</a>
    </h3>
    
      <div class="author__bio p-note" itemprop="description">
        <p>The [Sporty / Home Automation / Developer] guy</p>

      </div>
    
  </div>

  <div class="author__urls-wrapper">
    <button class="btn btn--inverse">Follow</button>
    <ul class="author__urls social-icons">
      
        <li itemprop="homeLocation" itemscope itemtype="https://schema.org/Place">
          <i class="fas fa-fw fa-map-marker-alt" aria-hidden="true"></i> <span itemprop="name" class="p-locality">Stockholm/Sweden</span>
        </li>
      

      
        
          
            <li><a href="https://twitter.com/lokanx" rel="nofollow noopener noreferrer me" itemprop="sameAs"><i class="fab fa-fw fa-twitter-square" aria-hidden="true"></i><span class="label">Twitter</span></a></li>
          
        
          
            <li><a href="https://github.com/lokanx" rel="nofollow noopener noreferrer me" itemprop="sameAs"><i class="fab fa-fw fa-github" aria-hidden="true"></i><span class="label">GitHub</span></a></li>
          
        
          
            <li><a href="https://www.linkedin.com/in/sjogrenbjorn" rel="nofollow noopener noreferrer me" itemprop="sameAs"><i class="fab fa-fw fa-linkedin" aria-hidden="true"></i><span class="label">LinkedIn</span></a></li>
          
        
      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      <!--
  <li>
    <a href="http://link-to-whatever-social-network.com/user/" itemprop="sameAs" rel="nofollow noopener noreferrer">
      <i class="fas fa-fw" aria-hidden="true"></i> Custom Social Profile Link
    </a>
  </li>
-->
    </ul>
  </div>
</div>
  
  </div>



  <article class="page" itemscope itemtype="https://schema.org/CreativeWork">
    <meta itemprop="headline" content="How to build docker containers using gitea runners">
    <meta itemprop="description" content="Gitea has pretty recently introduced actions, which is basically CI/CD pipelines. They work very match as Gitlab Actions. In fact a Gitea CI/CD pipeline is almost fully compatible with a Gitlab pipeline except a few minor details and limitations.You can even use Gitlab actions in your Gitea CI/CD pipeline build steps.">
    <meta itemprop="datePublished" content="2023-10-27T12:30:00+00:00">
    <meta itemprop="dateModified" content="2023-10-27T12:30:00+00:00">

    <div class="page__inner-wrap">
      
        <header>
          <h1 id="page-title" class="page__title" itemprop="headline">How to build docker containers using gitea runners
</h1>
          


        </header>
      

      <section class="page__content" itemprop="text">
        
        <p>Gitea has pretty recently introduced actions, which is basically CI/CD pipelines. 
They work very match as <a href="https://docs.gitlab.com/ee/ci/">Gitlab Actions</a>. 
In fact a Gitea CI/CD pipeline is almost fully compatible with a Gitlab pipeline except a few minor details and limitations.
You can even use Gitlab actions in your Gitea CI/CD pipeline build steps.</p>

<p>This article is about how to make your Gitea CI/CD pipeline build docker images.</p>

<p>Start by setting up gitea, <a href="https://docs.gitea.com/next/installation/install-with-docker">installation with docker</a>.
Don’t forget to enable actions in Gitea configuration file.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>[actions]
ENABLED=true
</code></pre></div></div>
<p>I also suggest you setup HTTPS with a valid certificate, you will run into problems else in your builds with 
complains about insecure stuff. How to do that is out of scope for this blog post, but you can read more
about it <a href="https://docs.gitea.com/administration/https-setup?_highlight=https">here</a>.</p>

<p>After that it’s time to <a href="https://docs.gitea.com/next/usage/actions/quickstart">set up the runners</a>. 
The documentation do not say anything about how to build different kind of artifacts. What you can build with a runner
is defined by it’s LABELS. A label maps to a docker container performing the build step in the CI/CD pipeline. If you
not specify any LABELS you get the default that can NOT build docker containers. To get that capability you can
make use of the <a href="https://github.com/catthehacker/docker_images">catthehacker docker images Github project</a>.</p>

<p>Anyway this is how I setup my runners</p>

<ol>
  <li>Create directory for your runners
    <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>mkdir gitea-runners
</code></pre></div>    </div>
  </li>
  <li>Then create a initial config file for the runner, binary could be downloaded <a href="https://dl.gitea.com/act_runner/">here</a>.
    <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>./act_runner generate-config &gt; config1.yaml
</code></pre></div>    </div>
  </li>
  <li>Now lets create a basic script file for fire up you runner docker container. 
How to get the token is covered by the <a href="https://docs.gitea.com/next/usage/actions/quickstart">Gitea Action Quick start</a> guide.
    <div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c">#!/bin/sh </span>
docker pull gitea/act_runner:latest
docker stop nazgul-runner-1
docker <span class="nb">rm </span>nazgul-runner-1
docker run <span class="se">\</span>
<span class="nt">--restart</span> always <span class="se">\</span>
<span class="nt">-v</span> <span class="nv">$PWD</span>/config1.yaml:/config.yaml <span class="se">\</span>
<span class="nt">-v</span> <span class="nv">$PWD</span>/data1:/data <span class="se">\</span>
<span class="nt">-v</span> /var/run/docker.sock:/var/run/docker.sock:rw <span class="se">\</span>
<span class="nt">-e</span> <span class="nv">CONFIG_FILE</span><span class="o">=</span>/config.yaml <span class="se">\</span>
<span class="nt">-e</span> <span class="nv">GITEA_INSTANCE_URL</span><span class="o">=</span>https://&lt;gitea.mydomain.con&gt;/ <span class="se">\</span>
<span class="nt">-e</span> <span class="nv">GITEA_RUNNER_REGISTRATION_TOKEN</span><span class="o">=</span>&lt;MyGiteaRunnerToken&gt; <span class="se">\</span>
<span class="nt">-e</span> <span class="nv">GITEA_RUNNER_NAME</span><span class="o">=</span>gitea-runner-1 <span class="se">\</span>
<span class="nt">-e</span> <span class="nv">GITEA_RUNNER_LABELS</span><span class="o">=</span>ubuntu-latest:docker://node:16-bullseye,ubuntu-22.04:docker://node:16-bullseye,ubuntu-20.04:docker://node:16-bullseye,ubuntu-18.04:docker://node:16-buster,cth-ubuntu-latest:docker://catthehacker/&gt;
<span class="nt">--name</span> nazgul-runner-1 <span class="se">\</span>
<span class="nt">-d</span> gitea/act_runner:latest <span class="se">\</span>
<span class="nt">--privileged</span>
</code></pre></div>    </div>
  </li>
  <li>Now you should have your first runner up and running, check in Gitea that it’s actually popped up.</li>
  <li>Enable actions for all your git repositories that you want, it’s a checkbox named actions under git repository basic settings.</li>
</ol>

<p>Now lets create a CI/CD pipeline for your git repository. I assume you are capable of creating the Dockerfile needed yourself.
The example bellow I took from a project with node backend using the express framework.</p>
<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">#</span>
<span class="c1"># .gitea/gitea-ci.yaml</span>
<span class="c1">#</span>

<span class="na">name</span><span class="pi">:</span> <span class="s">Build And Test</span>
<span class="na">run-name</span><span class="pi">:</span> <span class="s">$ is runs ci pipeline</span>
<span class="na">on</span><span class="pi">:</span> <span class="pi">[</span> <span class="nv">push</span> <span class="pi">]</span>

<span class="na">jobs</span><span class="pi">:</span>
  <span class="na">build</span><span class="pi">:</span>
    <span class="na">runs-on</span><span class="pi">:</span> <span class="s">ubuntu-latest</span>
    <span class="na">steps</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="na">uses</span><span class="pi">:</span> <span class="s">https://github.com/actions/checkout@v4</span>
      <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">Use Node.js</span>
        <span class="na">uses</span><span class="pi">:</span> <span class="s">https://github.com/actions/setup-node@v3</span>
        <span class="na">with</span><span class="pi">:</span>
          <span class="na">node-version</span><span class="pi">:</span> <span class="s1">'</span><span class="s">18.17'</span>
      <span class="pi">-</span> <span class="na">run</span><span class="pi">:</span> <span class="s">npm ci</span>
      <span class="pi">-</span> <span class="na">run</span><span class="pi">:</span> <span class="s">npm run lint</span>
      <span class="pi">-</span> <span class="na">run</span><span class="pi">:</span> <span class="s">npm run test</span>
      <span class="pi">-</span> <span class="na">run</span><span class="pi">:</span> <span class="s">npm run build:prod</span>
        <span class="na">env</span><span class="pi">:</span>
           <span class="na">NODE_OPTIONS</span><span class="pi">:</span> <span class="s">--max_old_space_size=4096</span>

  <span class="na">publish</span><span class="pi">:</span>
    <span class="na">runs-on</span><span class="pi">:</span> <span class="s">cth-ubuntu-latest</span>
    <span class="na">needs</span><span class="pi">:</span> <span class="s">build</span>
    <span class="na">if</span><span class="pi">:</span> <span class="s">gitea.ref == 'refs/heads/main'</span>
    <span class="na">steps</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="na">uses</span><span class="pi">:</span> <span class="s">https://github.com/actions/checkout@v4</span>
      <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">Set up Docker Buildx</span>
        <span class="na">uses</span><span class="pi">:</span> <span class="s">https://github.com/docker/setup-buildx-action@v3</span>
        <span class="na">with</span><span class="pi">:</span>
          <span class="na">config-inline</span><span class="pi">:</span> <span class="pi">|</span>
            <span class="s">[registry."&lt;my-private-unsecure-git-repository-ip-address&gt;:5000"]</span>
              <span class="s">http = true</span>
              <span class="s">insecure = true            </span>
      <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">Build and push Docker image</span>
        <span class="na">uses</span><span class="pi">:</span> <span class="s">https://github.com/docker/build-push-action@v5</span>
        <span class="na">with</span><span class="pi">:</span>
          <span class="na">context</span><span class="pi">:</span> <span class="s">.</span>
          <span class="na">file</span><span class="pi">:</span> <span class="s">./Dockerfile</span>
          <span class="na">push</span><span class="pi">:</span> <span class="kc">true</span>
          <span class="na">tags</span><span class="pi">:</span> <span class="s2">"</span><span class="s">&lt;my-private-unsecure-git-repository-ip-address&gt;:5000/&lt;my-docker-image&gt;:$,&lt;my-private-unsecure-git-repository-ip-address&gt;:5000/&lt;my-docker-image&gt;:latest"</span>
</code></pre></div></div>

<p>So the build pipeline contains two steps, build and publish. The first step executes for all pushes to all branches, 
the second step only for main branch. Pay attention to the second step runs on <em>cth-ubuntu-latest</em>. 
Which is one of the custom LABELS we added for our runner.</p>

<p>And here is a basic Dockerfile as reference.</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>#
# Dockerfile
#

FROM node:alpine
WORKDIR /usr/app
RUN apk update &amp;&amp; apk add libstdc++ &amp;&amp; apk add build-base &amp;&amp; apk add python3 &amp;&amp; apk add bash &amp;&amp; apk add git
COPY package.json .
COPY package-lock.json .
COPY src/app/public public
RUN npm ci
COPY . .
RUN npm run clean
RUN npm run build

CMD ["npm", "run", "prod"]
</code></pre></div></div>

        
      </section>

      <footer class="page__meta">
        
        
  


  

  <p class="page__taxonomy">
    <strong><i class="fas fa-fw fa-tags" aria-hidden="true"></i> Tags: </strong>
    <span itemprop="keywords">
    
      <a href="/tags/#ci-cd" class="page__taxonomy-item" rel="tag">ci/cd</a><span class="sep">, </span>
    
      <a href="/tags/#docker" class="page__taxonomy-item" rel="tag">docker</a><span class="sep">, </span>
    
      <a href="/tags/#docker-registry" class="page__taxonomy-item" rel="tag">docker-registry</a><span class="sep">, </span>
    
      <a href="/tags/#gitea" class="page__taxonomy-item" rel="tag">gitea</a>
    
    </span>
  </p>




  


  

  <p class="page__taxonomy">
    <strong><i class="fas fa-fw fa-folder-open" aria-hidden="true"></i> Categories: </strong>
    <span itemprop="keywords">
    
      <a href="/categories/#ci-cd" class="page__taxonomy-item" rel="tag">ci/cd</a><span class="sep">, </span>
    
      <a href="/categories/#docker" class="page__taxonomy-item" rel="tag">docker</a>
    
    </span>
  </p>


        

  <p class="page__date"><strong><i class="fas fa-fw fa-calendar-alt" aria-hidden="true"></i> Updated:</strong> <time datetime="2023-10-27">October 27, 2023</time></p>


      </footer>

      

      
  <nav class="pagination">
    
      <a href="/docker/ci/cd/2023/10/09/trigger-action-when-continer-pushed.html" class="pagination--pager" title="Using webhooks to trigger actions when a docker image are pushed to a private docker registry
">Previous</a>
    
    
      <a href="#" class="pagination--pager disabled">Next</a>
    
  </nav>

    </div>

    
  </article>

  
  
</div>

    </div>

    
      <div class="search-content">
        <div class="search-content__inner-wrap"><form class="search-content__form" onkeydown="return event.key != 'Enter';">
    <label class="sr-only" for="search">
      Enter your search term...
    </label>
    <input type="search" id="search" class="search-input" tabindex="-1" placeholder="Enter your search term..." />
  </form>
  <div id="results" class="results"></div></div>

      </div>
    

    <div id="footer" class="page__footer">
      <footer>
        <!-- start custom footer snippets -->

<!-- end custom footer snippets -->
        <div class="page__footer-follow">
  <ul class="social-icons">
    

    
      
        
          <li><a href="https://twitter.com/lokanx" rel="nofollow noopener noreferrer"><i class="fab fa-fw fa-twitter-square" aria-hidden="true"></i> Twitter</a></li>
        
      
        
          <li><a href="https://github.com/lokanx" rel="nofollow noopener noreferrer"><i class="fab fa-fw fa-github" aria-hidden="true"></i> GitHub</a></li>
        
      
        
          <li><a href="https://www.linkedin.com/in/sjogrenbjorn" rel="nofollow noopener noreferrer"><i class="fab fa-fw fa-linkedin" aria-hidden="true"></i> LinkedIn</a></li>
        
      
    

    
      <li><a href="/feed.xml"><i class="fas fa-fw fa-rss-square" aria-hidden="true"></i> Feed</a></li>
    
  </ul>
</div>

<div class="page__footer-copyright">&copy; 2023 En utvecklares tankar.... Powered by <a href="https://jekyllrb.com" rel="nofollow">Jekyll</a> &amp; <a href="https://mademistakes.com/work/minimal-mistakes-jekyll-theme/" rel="nofollow">Minimal Mistakes</a>.</div>
      </footer>
    </div>

    
  <script src="/assets/js/main.min.js"></script>




<script src="/assets/js/lunr/lunr.min.js"></script>
<script src="/assets/js/lunr/lunr-store.js"></script>
<script src="/assets/js/lunr/lunr-en.js"></script>







  </body>
</html>
