<!doctype html>
<!--
  Minimal Mistakes Jekyll Theme 4.24.0 by Michael Rose
  Copyright 2013-2020 Michael Rose - mademistakes.com | @mmistakes
  Free for personal and commercial use under the MIT license
  https://github.com/mmistakes/minimal-mistakes/blob/master/LICENSE
-->
<html lang="en" class="no-js">
  <head>
    <meta charset="utf-8">

<!-- begin _includes/seo.html --><title>Skapa en REST baserad sensor för Home Assistant med hjälp an pyscript integrationen - A developers thoughts…</title>
<meta name="description" content="Har du känt att att RESTful Sensorn i Home Assistant inte räcker till. Är REST API bakom nån form av inloggningsflöde du behöver gå igenom innan du kan anropa API’et, eller du kanske vill kombinera data från flera REST anrop till en sensor. Du kan alltid skapa din egen kustomiserade integratiom, men det är rätt omstädnigt.">


  <meta name="author" content="Björn Sjögren">
  
  <meta property="article:author" content="Björn Sjögren">
  


<meta property="og:type" content="article">
<meta property="og:locale" content="en_US">
<meta property="og:site_name" content="A developers thoughts...">
<meta property="og:title" content="Skapa en REST baserad sensor för Home Assistant med hjälp an pyscript integrationen">
<meta property="og:url" content="https://www.lokan.net/home-assistant/2023/06/19/home-assistant-creating-rest-sensors-using-pyscript-post.html">


  <meta property="og:description" content="Har du känt att att RESTful Sensorn i Home Assistant inte räcker till. Är REST API bakom nån form av inloggningsflöde du behöver gå igenom innan du kan anropa API’et, eller du kanske vill kombinera data från flera REST anrop till en sensor. Du kan alltid skapa din egen kustomiserade integratiom, men det är rätt omstädnigt.">







  <meta property="article:published_time" content="2023-06-19T15:30:00+00:00">



  <meta property="article:modified_time" content="2023-06-19T15:30:00+00:00">




<link rel="canonical" href="https://www.lokan.net/sv/home-assistant/2023/06/19/home-assistant-creating-rest-sensors-using-pyscript-post.html">




<script type="application/ld+json">
  {
    "@context": "https://schema.org",
    
      "@type": "Person",
      "name": null,
      "url": "https://www.lokan.net/"
    
  }
</script>







<!-- end _includes/seo.html -->



  <link href="/sv/feed.xml" type="application/atom+xml" rel="alternate" title="A developers thoughts... Feed">


<!-- https://t.co/dKP3o1e -->
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<script>
  document.documentElement.className = document.documentElement.className.replace(/\bno-js\b/g, '') + ' js ';
</script>

<!-- For all browsers -->
<link rel="stylesheet" href="/assets/css/main.css">
<link rel="preload" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5/css/all.min.css" as="style" onload="this.onload=null;this.rel='stylesheet'">
<noscript><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5/css/all.min.css"></noscript>



    <!-- start custom head snippets -->

<!-- insert favicons. use https://realfavicongenerator.net/ -->

<!-- end custom head snippets -->

  </head>

  <body class="layout--single wide">
    <nav class="skip-links">
  <ul>
    <li><a href="#site-nav" class="screen-reader-shortcut">Skip to primary navigation</a></li>
    <li><a href="#main" class="screen-reader-shortcut">Skip to content</a></li>
    <li><a href="#footer" class="screen-reader-shortcut">Skip to footer</a></li>
  </ul>
</nav>

    <!--[if lt IE 9]>
<div class="notice--danger align-center" style="margin: 0;">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience.</div>
<![endif]-->

    
<style>
.greedy-nav .hidden-links div {
  margin: 0;
  padding: 10px 20px;
  font-size: 1em;
}
</style>
<div class="masthead">
   <div class="masthead__inner-wrap">
      <div class="masthead__menu">
         <nav id="site-nav" class="greedy-nav">
            
            <a class="site-title" href="/sv/">
               En utvecklares tankar... 
            </a>
            <ul class="visible-links">
<li class="masthead__menu-item">
                  <a href="/sv/">Hem</a>
               </li>
<li class="masthead__menu-item">
                  <a href="/sv/blog/">Blog</a>
               </li>
<li class="masthead__menu-item">
                  <a href="/sv/apps-archive/">Appl</a>
               </li>
<li class="masthead__menu-item">
                  <a href="/sv/about/">Om</a>
               </li>
<li class="masthead__menu-item">
                  <a href="/sv/contact/">Kontakt</a>
               </li>
<li class="masthead__menu-item">
                  <a href="/sv/sitemap/">Områdeskarta</a>
               </li>
   <li class="masthead__menu-item">
   
      
         <a href="/sv/" title="en" style="margin-left: 2px; margin-right: 2px" onclick="localStorage.setItem('site_active_lang', 'en');window.location.href='/';return false;">
            <img src="/assets/images/lang/en.svg" alt="en" style="width: 32px; max-width: 32px;">
         </a>
      

   
   </li>

   <li class="masthead__menu-item">
   
      <div>
         <img src="/assets/images/lang/sv.svg" alt="sv" title="sv" style="width: 32px;max-width: 32px; margin-left: 2px; margin-right: 2px">
      </div>
   
   </li>

</ul>
            
            <button class="search__toggle" type="button">
               <span class="visually-hidden">Toggle search</span>
               <i class="fas fa-search"></i>
            </button>
            
            <button class="greedy-nav__toggle hidden" type="button">
               <span class="visually-hidden">Toggle menu</span>
               <div class="navicon"></div>
            </button>
            <ul class="hidden-links hidden"></ul>
         </nav>
      </div>
   </div>
</div>

    <div class="initial-content">
      



<div id="main" role="main">
  
  <div class="sidebar sticky">
  


<div itemscope itemtype="https://schema.org/Person" class="h-card">

  

  <div class="author__content">
    <h3 class="author__name p-name" itemprop="name">
      <a class="u-url" rel="me" href="https://www.lokan.net/sv/" itemprop="url">Björn Sjögren</a>
    </h3>
    
      <div class="author__bio p-note" itemprop="description">
        <p>Den [Sportiga / Hemautomatiserings / Utvecklar] killen</p>

      </div>
    
  </div>

  <div class="author__urls-wrapper">
    <button class="btn btn--inverse">Follow</button>
    <ul class="author__urls social-icons">
      
        <li itemprop="homeLocation" itemscope itemtype="https://schema.org/Place">
          <i class="fas fa-fw fa-map-marker-alt" aria-hidden="true"></i> <span itemprop="name" class="p-locality">Stockholm/Sverige</span>
        </li>
      

      
        
          
            <li><a href="https://twitter.com/lokanx" rel="nofollow noopener noreferrer me" itemprop="sameAs"><i class="fab fa-fw fa-twitter-square" aria-hidden="true"></i><span class="label">Twitter</span></a></li>
          
        
          
            <li><a href="https://github.com/lokanx" rel="nofollow noopener noreferrer me" itemprop="sameAs"><i class="fab fa-fw fa-github" aria-hidden="true"></i><span class="label">GitHub</span></a></li>
          
        
          
            <li><a href="https://www.linkedin.com/in/sjogrenbjorn" rel="nofollow noopener noreferrer me" itemprop="sameAs"><i class="fab fa-fw fa-linkedin" aria-hidden="true"></i><span class="label">LinkedIn</span></a></li>
          
        
      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      <!--
  <li>
    <a href="http://link-to-whatever-social-network.com/user/" itemprop="sameAs" rel="nofollow noopener noreferrer">
      <i class="fas fa-fw" aria-hidden="true"></i> Custom Social Profile Link
    </a>
  </li>
-->
    </ul>
  </div>
</div>
  
  </div>



  <article class="page" itemscope itemtype="https://schema.org/CreativeWork">
    <meta itemprop="headline" content="Skapa en REST baserad sensor för Home Assistant med hjälp an pyscript integrationen">
    <meta itemprop="description" content="Har du känt att att RESTful Sensorn i Home Assistant inte räcker till. Är REST API bakom nån form av inloggningsflöde du behöver gå igenom innan du kan anropa API’et, eller du kanske vill kombinera data från flera REST anrop till en sensor. Du kan alltid skapa din egen kustomiserade integratiom, men det är rätt omstädnigt.">
    <meta itemprop="datePublished" content="2023-06-19T15:30:00+00:00">
    <meta itemprop="dateModified" content="2023-06-19T15:30:00+00:00">

    <div class="page__inner-wrap">
      
        <header>
          <h1 id="page-title" class="page__title" itemprop="headline">Skapa en REST baserad sensor för Home Assistant med hjälp an pyscript integrationen
</h1>
          


        </header>
      

      <section class="page__content" itemprop="text">
        
        <p>Har du känt att att <a href="https://www.home-assistant.io/integrations/sensor.rest/">RESTful Sensorn</a> i <a href="https://www.home-assistant.io">Home Assistant</a> inte räcker till. Är REST API bakom nån form av inloggningsflöde du behöver gå igenom innan du kan anropa API’et, eller du kanske vill kombinera data från flera REST anrop till en sensor. Du kan alltid skapa din egen kustomiserade integratiom, men det är rätt omstädnigt.</p>

<p>Det finns en integration tillgänglig via <a href="https://hacs.xyz">HACS</a> som heter <a href="https://github.com/custom-components/pyscript">pyscript</a> som låter dig enkelt skapa sensorer och mycket mer.</p>

<p>För att köra igång pyscript i din Home Assistant installation genom att följa instruktionen nedan:</p>

<ol>
  <li>Först installera <a href="https://hacs.xyz/">HACS</a> om du inte redan gjort det.</li>
  <li>Hitta <a href="https://github.com/custom-components/pyscript">pyscript</a> integrationen i HACS och installera den.</li>
  <li>Lägg till pyscript integration genom lägga till följande konfiguration
    <div class="language-yaml highlighter-rouge">
<div class="highlight"><pre class="highlight"><code><span class="na">pyscript</span><span class="pi">:</span>
<span class="na">allow_all_imports</span><span class="pi">:</span> <span class="kc">true</span>
<span class="na">hass_is_global</span><span class="pi">:</span> <span class="kc">true</span>
</code></pre></div>    </div>
  </li>
  <li>SKapa en katalog som heter pyscript i rooten av din home assistant konfigurationskatalog
    <div class="language-plaintext highlighter-rouge">
<div class="highlight"><pre class="highlight"><code>cd /path/to/home-assisant/config
mkdir pyscript
</code></pre></div>    </div>
  </li>
  <li>Starta om Home Assistant för att aktivera integrationen.</li>
  <li>Skapa en fil för din REST sensor i <ha-config-dir>/pyscrupt/my-rest-sensor.py</ha-config-dir>
</li>
  <li>Installera en riktig python kapabel editor, som Visual Studio Code (valfritt)</li>
</ol>

<p>Det finns många sätt konfigurera pyscript, men med exmplet ovan så kommer pyscript hitta alla python filer i katalogen. Varje gång en fil ändras så kommer integration automatiskt ladda om filen. Håll ett öga på home-assistant.log filen efter fel medans du kodar.</p>

<p>Här är ett fullt exempel på en sensor som hämtar data från <a href="https://api.krisinformation.se/v3/">Svenska Krisinformations API Version 3</a> API. Sensorn är kompatibel med <a href="https://github.com/isabellaalstrom/krisinfo-card">krisinfo-card</a> kortet men använder senste versionen av API’et till skillnad från orginal integrationen.</p>

<p>Koden definierar en service metod för manuel uppdatering av sensor informationen samt en skedulerad uppdatering som pollar efter nytt data var 30e minut. Som man kan se så är det ganska enkelt skapa sensorer eller service metoder jämfört med skapa en fullständigt egen integration. Pyscript låter dig fokusera på logiken.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="n">requests</span>
<span class="kn">from</span> <span class="n">math</span> <span class="kn">import</span> <span class="n">radians</span><span class="p">,</span> <span class="n">sin</span><span class="p">,</span> <span class="n">cos</span><span class="p">,</span> <span class="n">acos</span>

<span class="n">URL</span> <span class="o">=</span> <span class="sh">"</span><span class="s">https://api.krisinformation.se/v3/news?days={days}&amp;counties={counties}</span><span class="sh">"</span>
<span class="n">RADIUS</span> <span class="o">=</span> <span class="sh">"</span><span class="s">50</span><span class="sh">"</span>
<span class="n">SLAT</span> <span class="o">=</span> <span class="sa">f</span><span class="sh">'</span><span class="si">{</span><span class="n">hass</span><span class="p">.</span><span class="n">config</span><span class="p">.</span><span class="n">latitude</span><span class="si">}</span><span class="sh">'</span>
<span class="n">SLON</span> <span class="o">=</span> <span class="sa">f</span><span class="sh">'</span><span class="si">{</span><span class="n">hass</span><span class="p">.</span><span class="n">config</span><span class="p">.</span><span class="n">longitude</span><span class="si">}</span><span class="sh">'</span>
<span class="n">DAYS</span> <span class="o">=</span> <span class="mi">7</span>
<span class="n">COUNTY_GOTHENBURG</span> <span class="o">=</span> <span class="mi">14</span>

<span class="k">def</span> <span class="nf">getUrl</span><span class="p">(</span><span class="n">days</span><span class="p">,</span> <span class="n">counties</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">URL</span><span class="p">.</span><span class="nf">format</span><span class="p">(</span><span class="n">days</span><span class="o">=</span><span class="n">days</span><span class="p">,</span> <span class="n">counties</span><span class="o">=</span><span class="n">counties</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">fetchData</span><span class="p">(</span><span class="n">url</span><span class="p">):</span>
    <span class="n">log</span><span class="p">.</span><span class="nf">info</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">Fetching data from: </span><span class="si">{</span><span class="n">url</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>
    <span class="n">response</span> <span class="o">=</span> <span class="n">task</span><span class="p">.</span><span class="nf">executor</span><span class="p">(</span><span class="n">requests</span><span class="p">.</span><span class="n">get</span><span class="p">,</span> <span class="n">url</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">response</span><span class="p">.</span><span class="n">status_code</span> <span class="o">!=</span> <span class="mi">200</span><span class="p">:</span>
        <span class="n">log</span><span class="p">.</span><span class="nf">error</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">Failure: </span><span class="si">{</span><span class="n">response</span><span class="p">.</span><span class="n">status_code</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">None</span>

    <span class="k">return</span> <span class="n">response</span><span class="p">.</span><span class="nf">json</span><span class="p">()</span>

<span class="k">def</span> <span class="nf">make_object</span><span class="p">(</span><span class="n">attributes</span><span class="p">,</span> <span class="n">index</span><span class="p">,</span> <span class="n">element</span><span class="p">):</span>
    <span class="n">message</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">message</span><span class="p">[</span><span class="sh">'</span><span class="s">Area</span><span class="sh">'</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="n">distance</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="n">within_range</span> <span class="o">=</span> <span class="bp">False</span>
    <span class="n">is_in_county</span> <span class="o">=</span> <span class="bp">False</span>
    <span class="n">is_in_country</span> <span class="o">=</span> <span class="bp">False</span>

    <span class="k">for</span> <span class="n">count</span><span class="p">,</span> <span class="n">area</span> <span class="ow">in</span> <span class="nf">enumerate</span><span class="p">(</span><span class="n">element</span><span class="p">[</span><span class="sh">'</span><span class="s">Area</span><span class="sh">'</span><span class="p">]):</span>
        <span class="n">message</span><span class="p">[</span><span class="sh">'</span><span class="s">Area</span><span class="sh">'</span><span class="p">].</span><span class="nf">append</span><span class="p">({</span> <span class="sh">"</span><span class="s">Type</span><span class="sh">"</span> <span class="p">:</span> <span class="n">area</span><span class="p">[</span><span class="sh">'</span><span class="s">Type</span><span class="sh">'</span><span class="p">],</span> <span class="sh">"</span><span class="s">Description</span><span class="sh">"</span> <span class="p">:</span> <span class="n">area</span><span class="p">[</span><span class="sh">'</span><span class="s">Description</span><span class="sh">'</span><span class="p">],</span> <span class="sh">"</span><span class="s">Coordinate</span><span class="sh">"</span> <span class="p">:</span> <span class="n">area</span><span class="p">[</span><span class="sh">'</span><span class="s">Coordinate</span><span class="sh">'</span><span class="p">]})</span>

        <span class="k">if</span> <span class="n">area</span><span class="p">[</span><span class="sh">'</span><span class="s">Type</span><span class="sh">'</span><span class="p">]</span> <span class="o">==</span> <span class="sh">'</span><span class="s">Country</span><span class="sh">'</span><span class="p">:</span>
            <span class="n">is_in_country</span> <span class="o">=</span> <span class="bp">True</span>

        <span class="k">if</span> <span class="n">area</span><span class="p">[</span><span class="sh">'</span><span class="s">Type</span><span class="sh">'</span><span class="p">]</span> <span class="o">==</span> <span class="sh">'</span><span class="s">County</span><span class="sh">'</span><span class="p">:</span>
            <span class="n">is_in_county</span> <span class="o">=</span> <span class="bp">True</span>

        <span class="n">distance</span> <span class="o">=</span> <span class="nf">calculate_distance</span><span class="p">(</span><span class="n">coords</span> <span class="o">=</span> <span class="n">area</span><span class="p">[</span><span class="sh">'</span><span class="s">Coordinate</span><span class="sh">'</span><span class="p">])</span>
        <span class="k">if</span> <span class="nf">float</span><span class="p">(</span><span class="n">distance</span><span class="p">)</span> <span class="o">&lt;</span> <span class="nf">float</span><span class="p">(</span><span class="n">RADIUS</span><span class="p">):</span>
            <span class="n">within_range</span> <span class="o">=</span> <span class="bp">True</span>

    <span class="k">if</span> <span class="n">within_range</span> <span class="ow">or</span> <span class="n">is_in_county</span> <span class="ow">or</span> <span class="n">is_in_country</span><span class="p">:</span>
        <span class="n">message</span><span class="p">[</span><span class="sh">'</span><span class="s">ID</span><span class="sh">'</span><span class="p">]</span> <span class="o">=</span> <span class="n">element</span><span class="p">[</span><span class="sh">'</span><span class="s">Identifier</span><span class="sh">'</span><span class="p">]</span>
        <span class="n">message</span><span class="p">[</span><span class="sh">'</span><span class="s">Message</span><span class="sh">'</span><span class="p">]</span> <span class="o">=</span> <span class="n">element</span><span class="p">[</span><span class="sh">'</span><span class="s">PushMessage</span><span class="sh">'</span><span class="p">]</span>
        <span class="n">message</span><span class="p">[</span><span class="sh">'</span><span class="s">Updated</span><span class="sh">'</span><span class="p">]</span> <span class="o">=</span> <span class="n">element</span><span class="p">[</span><span class="sh">'</span><span class="s">Updated</span><span class="sh">'</span><span class="p">]</span>
        <span class="n">message</span><span class="p">[</span><span class="sh">'</span><span class="s">Published</span><span class="sh">'</span><span class="p">]</span> <span class="o">=</span> <span class="n">element</span><span class="p">[</span><span class="sh">'</span><span class="s">Published</span><span class="sh">'</span><span class="p">]</span>
        <span class="n">message</span><span class="p">[</span><span class="sh">'</span><span class="s">Headline</span><span class="sh">'</span><span class="p">]</span> <span class="o">=</span> <span class="n">element</span><span class="p">[</span><span class="sh">'</span><span class="s">Headline</span><span class="sh">'</span><span class="p">]</span>
        <span class="n">message</span><span class="p">[</span><span class="sh">'</span><span class="s">Preamble</span><span class="sh">'</span><span class="p">]</span> <span class="o">=</span> <span class="n">element</span><span class="p">[</span><span class="sh">'</span><span class="s">Preamble</span><span class="sh">'</span><span class="p">]</span>
        <span class="n">message</span><span class="p">[</span><span class="sh">'</span><span class="s">BodyText</span><span class="sh">'</span><span class="p">]</span> <span class="o">=</span> <span class="n">element</span><span class="p">[</span><span class="sh">'</span><span class="s">BodyText</span><span class="sh">'</span><span class="p">]</span>
        <span class="n">message</span><span class="p">[</span><span class="sh">'</span><span class="s">Web</span><span class="sh">'</span><span class="p">]</span> <span class="o">=</span> <span class="n">element</span><span class="p">[</span><span class="sh">'</span><span class="s">Web</span><span class="sh">'</span><span class="p">]</span>
        <span class="n">message</span><span class="p">[</span><span class="sh">'</span><span class="s">Language</span><span class="sh">'</span><span class="p">]</span> <span class="o">=</span> <span class="n">element</span><span class="p">[</span><span class="sh">'</span><span class="s">Language</span><span class="sh">'</span><span class="p">]</span>
        <span class="n">message</span><span class="p">[</span><span class="sh">'</span><span class="s">Event</span><span class="sh">'</span><span class="p">]</span> <span class="o">=</span> <span class="n">element</span><span class="p">[</span><span class="sh">'</span><span class="s">Event</span><span class="sh">'</span><span class="p">]</span>
        <span class="n">message</span><span class="p">[</span><span class="sh">'</span><span class="s">SenderName</span><span class="sh">'</span><span class="p">]</span> <span class="o">=</span> <span class="n">element</span><span class="p">[</span><span class="sh">'</span><span class="s">SenderName</span><span class="sh">'</span><span class="p">]</span>
        <span class="n">message</span><span class="p">[</span><span class="sh">'</span><span class="s">Links</span><span class="sh">'</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="n">element</span><span class="p">[</span><span class="sh">'</span><span class="s">BodyLinks</span><span class="sh">'</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">numbers</span><span class="p">,</span> <span class="n">link</span> <span class="ow">in</span> <span class="nf">enumerate</span><span class="p">(</span><span class="n">element</span><span class="p">[</span><span class="sh">'</span><span class="s">BodyLinks</span><span class="sh">'</span><span class="p">]):</span>
                <span class="n">message</span><span class="p">[</span><span class="sh">'</span><span class="s">Links</span><span class="sh">'</span><span class="p">].</span><span class="nf">append</span><span class="p">(</span><span class="n">link</span><span class="p">[</span><span class="sh">'</span><span class="s">Url</span><span class="sh">'</span><span class="p">])</span>
        <span class="n">message</span><span class="p">[</span><span class="sh">'</span><span class="s">SourceID</span><span class="sh">'</span><span class="p">]</span> <span class="o">=</span> <span class="n">element</span><span class="p">[</span><span class="sh">'</span><span class="s">SourceID</span><span class="sh">'</span><span class="p">]</span>

        <span class="n">attributes</span><span class="p">[</span><span class="sh">"</span><span class="s">messages</span><span class="sh">"</span><span class="p">].</span><span class="nf">append</span><span class="p">(</span><span class="n">message</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">element</span><span class="p">[</span><span class="sh">'</span><span class="s">Event</span><span class="sh">'</span><span class="p">]</span> <span class="o">==</span> <span class="sh">"</span><span class="s">Alert</span><span class="sh">"</span><span class="p">:</span>
            <span class="n">attributes</span><span class="p">[</span><span class="sh">"</span><span class="s">alert_count</span><span class="sh">"</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">attributes</span><span class="p">[</span><span class="sh">"</span><span class="s">news_count</span><span class="sh">"</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="n">attributes</span><span class="p">[</span><span class="sh">"</span><span class="s">total_count</span><span class="sh">"</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">attributes</span><span class="p">[</span><span class="sh">"</span><span class="s">filtered_count</span><span class="sh">"</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>


<span class="k">def</span> <span class="nf">calculate_distance</span><span class="p">(</span><span class="n">coords</span><span class="p">):</span>
    <span class="n">coords</span> <span class="o">=</span> <span class="n">coords</span><span class="p">.</span><span class="nf">split</span><span class="p">()</span>
    <span class="n">coords</span> <span class="o">=</span> <span class="n">coords</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nf">split</span><span class="p">(</span><span class="sh">'</span><span class="s">,</span><span class="sh">'</span><span class="p">)</span>
    <span class="n">elon</span> <span class="o">=</span> <span class="n">coords</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">elat</span> <span class="o">=</span> <span class="n">coords</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>

    <span class="c1">#Convert coordinates to radians
</span>    <span class="n">elat2</span> <span class="o">=</span> <span class="nf">radians</span><span class="p">(</span><span class="nf">float</span><span class="p">(</span><span class="n">elat</span><span class="p">))</span>
    <span class="n">slat2</span> <span class="o">=</span> <span class="nf">radians</span><span class="p">(</span><span class="nf">float</span><span class="p">(</span><span class="n">SLAT</span><span class="p">))</span>
    <span class="n">elon2</span> <span class="o">=</span> <span class="nf">radians</span><span class="p">(</span><span class="nf">float</span><span class="p">(</span><span class="n">elon</span><span class="p">))</span>
    <span class="n">slon2</span> <span class="o">=</span> <span class="nf">radians</span><span class="p">(</span><span class="nf">float</span><span class="p">(</span><span class="n">SLON</span><span class="p">))</span>

    <span class="c1">#Calculate the distance between them
</span>    <span class="n">dist</span> <span class="o">=</span> <span class="mf">6371.01</span> <span class="o">*</span> <span class="nf">acos</span><span class="p">(</span><span class="nf">sin</span><span class="p">(</span><span class="n">slat2</span><span class="p">)</span><span class="o">*</span><span class="nf">sin</span><span class="p">(</span><span class="n">elat2</span><span class="p">)</span> <span class="o">+</span> <span class="nf">cos</span><span class="p">(</span><span class="n">slat2</span><span class="p">)</span><span class="o">*</span><span class="nf">cos</span><span class="p">(</span><span class="n">elat2</span><span class="p">)</span><span class="o">*</span><span class="nf">cos</span><span class="p">(</span><span class="n">slon2</span> <span class="o">-</span> <span class="n">elon2</span><span class="p">))</span>

    <span class="k">return</span> <span class="n">dist</span>


<span class="k">def</span> <span class="nf">parseData</span><span class="p">(</span><span class="n">json_data</span><span class="p">):</span>
    <span class="n">attributes</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">attributes</span><span class="p">[</span><span class="sh">"</span><span class="s">messages</span><span class="sh">"</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">attributes</span><span class="p">[</span><span class="sh">"</span><span class="s">news_count</span><span class="sh">"</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">attributes</span><span class="p">[</span><span class="sh">"</span><span class="s">alert_count</span><span class="sh">"</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">attributes</span><span class="p">[</span><span class="sh">"</span><span class="s">total_count</span><span class="sh">"</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">attributes</span><span class="p">[</span><span class="sh">"</span><span class="s">filtered_count</span><span class="sh">"</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">attributes</span><span class="p">[</span><span class="sh">"</span><span class="s">display_state</span><span class="sh">"</span><span class="p">]</span> <span class="o">=</span> <span class="sh">"</span><span class="s">No new messages</span><span class="sh">"</span>
    <span class="n">attributes</span><span class="p">[</span><span class="sh">"</span><span class="s">display_icon</span><span class="sh">"</span><span class="p">]</span> <span class="o">=</span> <span class="sh">"</span><span class="s">mdi:check-circle-outline</span><span class="sh">"</span>
    <span class="n">attributes</span><span class="p">[</span><span class="sh">"</span><span class="s">attribution</span><span class="sh">"</span><span class="p">]</span> <span class="o">=</span> <span class="sh">"</span><span class="s">krisinformation.se</span><span class="sh">"</span>

    <span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">element</span> <span class="ow">in</span> <span class="nf">enumerate</span><span class="p">(</span><span class="n">json_data</span><span class="p">):</span>
        <span class="n">attributes</span><span class="p">[</span><span class="sh">"</span><span class="s">filtered_count</span><span class="sh">"</span><span class="p">]</span> <span class="o">=+</span> <span class="mi">1</span>
        <span class="nf">make_object</span><span class="p">(</span><span class="n">attributes</span> <span class="o">=</span> <span class="n">attributes</span><span class="p">,</span> <span class="n">index</span> <span class="o">=</span> <span class="n">index</span><span class="p">,</span> <span class="n">element</span> <span class="o">=</span> <span class="n">element</span><span class="p">)</span>

        <span class="nf">if </span><span class="p">(</span><span class="n">attributes</span><span class="p">[</span><span class="sh">"</span><span class="s">news_count</span><span class="sh">"</span><span class="p">]</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">):</span>
            <span class="n">attributes</span><span class="p">[</span><span class="sh">"</span><span class="s">display_state</span><span class="sh">"</span><span class="p">]</span> <span class="o">=</span> <span class="sa">f</span><span class="sh">"</span><span class="si">{</span><span class="n">attributes</span><span class="p">[</span><span class="sh">'</span><span class="s">news_count</span><span class="sh">'</span><span class="p">]</span><span class="si">}</span><span class="s"> News Messages</span><span class="sh">"</span>
            <span class="n">attributes</span><span class="p">[</span><span class="sh">"</span><span class="s">display_icon</span><span class="sh">"</span><span class="p">]</span> <span class="o">=</span> <span class="sh">"</span><span class="s">mdi:alert-circle-outline</span><span class="sh">"</span>

        <span class="nf">if </span><span class="p">(</span><span class="n">attributes</span><span class="p">[</span><span class="sh">"</span><span class="s">alert_count</span><span class="sh">"</span><span class="p">]</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">):</span>
            <span class="n">attributes</span><span class="p">[</span><span class="sh">"</span><span class="s">display_state</span><span class="sh">"</span><span class="p">]</span> <span class="o">=</span> <span class="sa">f</span><span class="sh">"</span><span class="si">{</span><span class="n">attributes</span><span class="p">[</span><span class="sh">'</span><span class="s">alert_count</span><span class="sh">'</span><span class="p">]</span><span class="si">}</span><span class="s"> Alert Messages</span><span class="sh">"</span>
            <span class="n">attributes</span><span class="p">[</span><span class="sh">"</span><span class="s">display_icon</span><span class="sh">"</span><span class="p">]</span> <span class="o">=</span> <span class="sh">"</span><span class="s">mdi:alert-circle</span><span class="sh">"</span>

    <span class="k">return</span> <span class="n">attributes</span>


<span class="k">def</span> <span class="nf">updateSensor</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">sensor_name</span><span class="p">,</span> <span class="n">friendly_name</span><span class="p">):</span>
    <span class="n">log</span><span class="p">.</span><span class="nf">debug</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">Fetching data from: </span><span class="si">{</span><span class="n">url</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>
    <span class="n">json_data</span> <span class="o">=</span> <span class="nf">fetchData</span><span class="p">(</span><span class="n">url</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">json_data</span> <span class="o">==</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">state</span><span class="p">.</span><span class="nf">set</span><span class="p">(</span><span class="n">sensor_name</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
        <span class="k">return</span>

    <span class="n">log</span><span class="p">.</span><span class="nf">debug</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">Got: </span><span class="si">{</span><span class="n">json_data</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>
    <span class="n">current_state</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">if</span> <span class="n">sensor_name</span> <span class="ow">in</span> <span class="n">state</span><span class="p">.</span><span class="nf">names</span><span class="p">(</span><span class="sh">'</span><span class="s">sensor</span><span class="sh">'</span><span class="p">):</span>
        <span class="n">current_state</span> <span class="o">=</span> <span class="n">state</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="n">sensor_name</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">state</span><span class="p">.</span><span class="nf">set</span><span class="p">(</span><span class="n">sensor_name</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>

    <span class="n">attributes</span> <span class="o">=</span> <span class="nf">parseData</span><span class="p">(</span><span class="n">json_data</span><span class="p">)</span>
    <span class="n">attributes</span><span class="p">[</span><span class="sh">'</span><span class="s">friendly_name</span><span class="sh">'</span><span class="p">]</span> <span class="o">=</span> <span class="n">friendly_name</span>

    <span class="n">new_state</span> <span class="o">=</span> <span class="sa">f</span><span class="sh">"</span><span class="si">{</span><span class="n">attributes</span><span class="p">[</span><span class="sh">'</span><span class="s">total_count</span><span class="sh">'</span><span class="p">]</span><span class="si">}</span><span class="sh">"</span>

    <span class="k">if</span> <span class="n">current_state</span> <span class="o">==</span> <span class="n">new_state</span><span class="p">:</span>
        <span class="n">log</span><span class="p">.</span><span class="nf">debug</span><span class="p">(</span><span class="sa">f</span><span class="sh">'</span><span class="s">State unchanged for: </span><span class="si">{</span><span class="n">sensor_name</span><span class="si">}</span><span class="sh">'</span><span class="p">)</span>
        <span class="k">return</span>

    <span class="n">log</span><span class="p">.</span><span class="nf">info</span><span class="p">(</span><span class="sa">f</span><span class="sh">'</span><span class="s">Updating state: </span><span class="si">{</span><span class="n">sensor_name</span><span class="si">}</span><span class="sh">'</span><span class="p">)</span>
    <span class="n">state</span><span class="p">.</span><span class="nf">set</span><span class="p">(</span><span class="n">sensor_name</span><span class="p">,</span> <span class="n">new_state</span><span class="p">,</span> <span class="n">attributes</span><span class="p">)</span>


<span class="nd">@time_trigger</span><span class="p">(</span><span class="sh">"</span><span class="s">cron(*/30 * * * *)</span><span class="sh">"</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">krisinformation_gbg</span><span class="p">():</span>
    <span class="n">url</span> <span class="o">=</span> <span class="nf">getUrl</span><span class="p">(</span><span class="n">DAYS</span><span class="p">,</span> <span class="n">COUNTY_GOTHENBURG</span><span class="p">)</span>
    <span class="nf">updateSensor</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="sh">'</span><span class="s">sensor.krisinformation_goteborg</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">Krisinformation Göteborg</span><span class="sh">'</span><span class="p">)</span>


<span class="nd">@service</span>
<span class="k">def</span> <span class="nf">krisinformation_testing</span><span class="p">():</span>
    <span class="nf">krisinformation_gbg</span><span class="p">()</span>
</code></pre></div></div>

<p>Lycka till och lycklig pyscript hackande ! <img class="emoji" title=":smiley:" alt=":smiley:" src="https://github.githubassets.com/images/icons/emoji/unicode/1f603.png" height="20" width="20"></p>

        
      </section>

      <footer class="page__meta">
        
        
  


  

  <p class="page__taxonomy">
    <strong><i class="fas fa-fw fa-tags" aria-hidden="true"></i> Tags: </strong>
    <span itemprop="keywords">
    
      <a href="/sv/tags/#home-assistant" class="page__taxonomy-item" rel="tag">home-assistant</a><span class="sep">, </span>
    
      <a href="/sv/tags/#pyscript" class="page__taxonomy-item" rel="tag">pyscript</a><span class="sep">, </span>
    
      <a href="/sv/tags/#python" class="page__taxonomy-item" rel="tag">python</a><span class="sep">, </span>
    
      <a href="/sv/tags/#rest" class="page__taxonomy-item" rel="tag">rest</a>
    
    </span>
  </p>




  


  

  <p class="page__taxonomy">
    <strong><i class="fas fa-fw fa-folder-open" aria-hidden="true"></i> Categories: </strong>
    <span itemprop="keywords">
    
      <a href="/sv/categories/#home-assistant" class="page__taxonomy-item" rel="tag">home-assistant</a>
    
    </span>
  </p>


        

  <p class="page__date"><strong><i class="fas fa-fw fa-calendar-alt" aria-hidden="true"></i> Updated:</strong> <time datetime="2023-06-19">June 19, 2023</time></p>


      </footer>

      

      
  <nav class="pagination">
    
      <a href="#" class="pagination--pager disabled">Previous</a>
    
    
      <a href="/sv/home-assistant/2023/06/19/sending-home-assistant-logs-to-elasticsearch-post.html" class="pagination--pager" title="Sending Home Assistant logs to Elasticsearch (ELK)
">Next</a>
    
  </nav>

    </div>

    
  </article>

  
  
</div>

    </div>

    
      <div class="search-content">
        <div class="search-content__inner-wrap">
<form class="search-content__form" onkeydown="return event.key != 'Enter';">
    <label class="sr-only" for="search">
      Enter your search term...
    </label>
    <input type="search" id="search" class="search-input" tabindex="-1" placeholder="Enter your search term...">
  </form>
  <div id="results" class="results"></div>
</div>

      </div>
    

    <div id="footer" class="page__footer">
      <footer>
        <!-- start custom footer snippets -->

<!-- end custom footer snippets -->
        <div class="page__footer-follow">
  <ul class="social-icons">
    

    
      
        
          <li><a href="https://twitter.com/lokanx" rel="nofollow noopener noreferrer"><i class="fab fa-fw fa-twitter-square" aria-hidden="true"></i> Twitter</a></li>
        
      
        
          <li><a href="https://github.com/lokanx" rel="nofollow noopener noreferrer"><i class="fab fa-fw fa-github" aria-hidden="true"></i> GitHub</a></li>
        
      
        
          <li><a href="https://www.linkedin.com/in/sjogrenbjorn" rel="nofollow noopener noreferrer"><i class="fab fa-fw fa-linkedin" aria-hidden="true"></i> LinkedIn</a></li>
        
      
    

    
      <li><a href="/sv/feed.xml"><i class="fas fa-fw fa-rss-square" aria-hidden="true"></i> Feed</a></li>
    
  </ul>
</div>

<div class="page__footer-copyright">© 2023 En utvecklares tankar.... Powered by <a href="https://jekyllrb.com" rel="nofollow">Jekyll</a> &amp; <a href="https://mademistakes.com/work/minimal-mistakes-jekyll-theme/" rel="nofollow">Minimal Mistakes</a>.</div>
      </footer>
    </div>

    
  <script src="/assets/js/main.min.js"></script>




<script src="/assets/js/lunr/lunr.min.js"></script>
<script src="/assets/js/lunr/lunr-store.js"></script>
<script src="/assets/js/lunr/lunr-en.js"></script>







  </body>
</html>
